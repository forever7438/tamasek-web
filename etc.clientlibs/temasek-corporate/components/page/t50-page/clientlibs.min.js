/**
 * Copyright (c) 2007 Ariel Flesler - aflesler ○ gmail • com | https://github.com/flesler
 * Licensed under MIT
 * @author Ariel Flesler
 * @version 2.1.3
 */
;(function(factory){'use strict';if(typeof define==='function'&&define.amd){define(['jquery'],factory)}else if(typeof module!=='undefined'&&module.exports){module.exports=factory(require('jquery'))}else{factory(jQuery)}})(function($){'use strict';var $scrollTo=$.scrollTo=function(target,duration,settings){return $(window).scrollTo(target,duration,settings)};$scrollTo.defaults={axis:'xy',duration:0,limit:true};function isWin(elem){return!elem.nodeName||$.inArray(elem.nodeName.toLowerCase(),['iframe','#document','html','body'])!==-1}function isFunction(obj){return typeof obj==='function'}$.fn.scrollTo=function(target,duration,settings){if(typeof duration==='object'){settings=duration;duration=0}if(typeof settings==='function'){settings={onAfter:settings}}if(target==='max'){target=9e9}settings=$.extend({},$scrollTo.defaults,settings);duration=duration||settings.duration;var queue=settings.queue&&settings.axis.length>1;if(queue){duration/=2}settings.offset=both(settings.offset);settings.over=both(settings.over);return this.each(function(){if(target===null){return}var win=isWin(this),elem=win?this.contentWindow||window:this,$elem=$(elem),targ=target,attr={},toff;switch(typeof targ){case 'number':case 'string':if(/^([+-]=?)?\d+(\.\d+)?(px|%)?$/.test(targ)){targ=both(targ);break}targ=win?$(targ):$(targ,elem);case 'object':if(targ.length===0){return}if(targ.is||targ.style){toff=(targ=$(targ)).offset()}}var offset=isFunction(settings.offset)&&settings.offset(elem,targ)||settings.offset;$.each(settings.axis.split(''),function(i,axis){var Pos=axis==='x'?'Left':'Top',pos=Pos.toLowerCase(),key='scroll'+Pos,prev=$elem[key](),max=$scrollTo.max(elem,axis);if(toff){attr[key]=toff[pos]+(win?0:prev-$elem.offset()[pos]);if(settings.margin){attr[key]-=parseInt(targ.css('margin'+Pos),10)||0;attr[key]-=parseInt(targ.css('border'+Pos+'Width'),10)||0}attr[key]+=offset[pos]||0;if(settings.over[pos]){attr[key]+=targ[axis==='x'?'width':'height']()*settings.over[pos]}}else{var val=targ[pos];attr[key]=val.slice&&val.slice(-1)==='%'?parseFloat(val)/100*max:val}if(settings.limit&&/^\d+$/.test(attr[key])){attr[key]=attr[key]<=0?0:Math.min(attr[key],max)}if(!i&&settings.axis.length>1){if(prev===attr[key]){attr={}}else if(queue){animate(settings.onAfterFirst);attr={}}}});animate(settings.onAfter);function animate(callback){var opts=$.extend({},settings,{queue:true,duration:duration,complete:callback&&function(){callback.call(elem,targ,settings)}});$elem.animate(attr,opts)}})};$scrollTo.max=function(elem,axis){var Dim=axis==='x'?'Width':'Height',scroll='scroll'+Dim;if(!isWin(elem)){return elem[scroll]-$(elem)[Dim.toLowerCase()]()}var size='client'+Dim,doc=elem.ownerDocument||elem.document,html=doc.documentElement,body=doc.body;return Math.max(html[scroll],body[scroll])-Math.min(html[size],body[size])};function both(val){return isFunction(val)||$.isPlainObject(val)?val:{top:val,left:val}}$.Tween.propHooks.scrollLeft=$.Tween.propHooks.scrollTop={get:function(t){return $(t.elem)[t.prop]()},set:function(t){var curr=this.get(t);if(t.options.interrupt&&t._last&&t._last!==curr){return $(t.elem).stop()}var next=Math.round(t.now);if(curr!==next){$(t.elem)[t.prop](next);t._last=this.get(t)}}};return $scrollTo});
/*jslint browser: true, fudge: true, long: true, white: true */
/*global socialShare */

jQuery(function ($) {
    "use strict";

    if (sessionStorage.getItem("preload")) {
        $("#preload").addClass("hide");
    }

    $(".t50-page .image-video-banner .btn-play").css("top", $(".banner-content-wrapper").offset().top + $(".banner-content-wrapper").height() - 40);

    function initSocialShare() {
        socialShare.initialize();
        $(document).on("ajaxComplete", function () {
            socialShare.events();
        });
    }

    if ($(".video-popup-wrapper").length > 0) {
        $(".t50-page .parsys > .parsys_column.column_4").addClass("video-popup-container");
        $(".video-popup-container .video-popup .video-popup-wrapper").append("<a href='' class='learn-more'><i class='ti-plus-thin'></i> <span>Learn more</span></a>");

        $(".video-popup-container .video-popup .video-popup-wrapper").each(function () {
            $(this).find(".video-popup-link img").prependTo($(this));
            $(this).find("p, .video-popup-link").wrapAll("<div class='writeup' />");
        });

        $(".video-popup-link").text("Watch video")
        $("body:not(.author-mode) .video-popup-container").addClass("expanded");
        $("body:not(.author-mode) .video-popup-container > .parsys_column:first-child").addClass("expand");
    }

    initSocialShare();
});

$(window).on("load", function () {

    var windowWidth = $(window).width();
    var totalSlideNav = $(".slider-nav a").length;
    var currentYear = "";

    function timelineTracking(activeSlide) {
        var currentIndex = $(".slider-nav ." + activeSlide).prevAll().length + 1;
        var year = activeSlide.substring(1, 5);
        var percentage = (100 * currentIndex) / totalSlideNav;
        if (year !== currentYear) {
            currentYear = year;
            window.dataLayer = window.dataLayer || []
            window.dataLayer.push({
                event: "timeline_scroll",
                year: year, // year the scroll took the user up to
                scrollThreshold: percentage, //percentage of total timeline scrolled 25, 50, 75, 100
                scrollDirection: "horizontal",
                scrollUnits: "percent"
            })
            
            $(".slider-nav").scrollTo($(".slider-nav a." + activeSlide), 0, { offset: 0 });
        }
    }

    if ($("body:not(.author-mode) #preload").length > 0) {

        setTimeout(function () {
            sessionStorage.setItem("preload", 1);
            $("#preload").fadeOut("fast");
        }, 2500);
    }
    $(".image-video-banner-wrapper .btn-play").on("click", function () {
        $(".popup-video").fadeIn("fast");
        $(".popup-video").css("display", "flex");
        $('.popup-video video').trigger('play');
        $('.popup-video video').attr('controls', "controls");
    });

    $(".popup-video .close-popup").on("click", function (e) {
        e.preventDefault();
        $(".popup-video").fadeOut("fast");

        $('.popup-video video').trigger('pause');
    });

    $(".t50-timeline .show-popup").on("click", function (e) {
        e.preventDefault();

        $(this).parentsUntil(".slide").find(".pop-up").fadeIn();
    });

    $(".t50-page").on("click", ".video-popup-container .learn-more", function (e) {
        e.preventDefault();
        $(".t50-page .video-popup-container .parsys_column").removeClass("expand");
        $(this).parentsUntil(".video-popup-container").addClass("expand");
        $(".video-popup-container").addClass("expanded");
    });

    $(".t50-page").on("click", ".video-popup-container .parsys_column:not(.expand)", function (e) {
        e.preventDefault();
        $(".t50-page .video-popup-container .parsys_column").removeClass("expand");
        $(this).addClass("expand");
        $(".video-popup-container").addClass("expanded");

        resizeVideoSection();
    });

    setTimeout(function () {
        $(".author-mode video").trigger('pause');
    }, 2000);

    $(window).on("resize", function () {
        t50Timeline();
        repositionPlayBtn();
        checkDevice();
        resizeVideoSection();
    });

    function checkDevice() {
        var scaling = window.devicePixelRatio;
        var zoom = (100 / scaling) / 100;

        if (zoom < 0.65) {
            zoom = 0.7;
        } else {
            zoom = 1;
        }

        if (!isMobile() && ($(".t50-timeline").outerHeight() > $(window).height())) {
            $(".t50-timeline").css("zoom", zoom);
        } else {
            $(".t50-timeline").css("zoom", "");
        }
    }

    function isMobile() {
        const regex = /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
        return regex.test(navigator.userAgent);
    }

    function repositionPlayBtn() {
        $(".t50-page .image-video-banner .btn-play").css("top", $(".banner-content-wrapper").offset().top + $(".banner-content-wrapper").height() - 40);
    }

    if (window.matchMedia("(pointer: coarse)").matches) {
        $(".scrollable").on("scroll", function (event) {
            $(".t50-timeline").addClass("scrolled");
            if (!$(".t50-timeline").hasClass("sticky")) {
                $(".t50-timeline").addClass("sticky");
            }
            checkVisibleSlide();
            highlightYearAndCat();
            handleTreeGrowth();
        });
    }

    function t50Timeline() {
        $(".scroll-to-explore").on("click", function () {
            $(".t50-timeline").addClass("scrolled");
            $(".slider-nav a.y1968").trigger("click");

            checkVisibleSlide();
            handleTreeGrowth();

        });

        // $(".t50-timeline").on('wheel', (function (e) {
        //     var offset = 0;

        //     e.preventDefault();

        //     if (windowWidth <= 768) {
        //         offset = 0;
        //     }

        //     $(".t50-timeline").addClass("scrolled");

        //     if (!$(".t50-timeline").hasClass("sticky")) {
        //         $(".t50-timeline").addClass("sticky");


        //         $('html, body').animate({
        //             scrollTop: $(".t50-timeline").offset().top - offset
        //         }, 200);

        //         setTimeout(function () {
        //             $(".fixed-header-theme.fixed-header").removeClass("fixed-header")

        //         }, 1500);
        //     }

        //     if (e.originalEvent.deltaY < 0) {
        //         document.querySelector('.t50-timeline .slides').scrollLeft -= 50;

        //     } else {
        //         document.querySelector('.t50-timeline .slides').scrollLeft += 50;
        //     }

        //     checkVisibleSlide();
        //     highlightYearAndCat();
        //     handleTreeGrowth();
        // }));

        $(".t50-timeline .slick-arrow").on("click", function () {
            $(".slider-nav .slick-current").click();
        })

        $(".t50-timeline .skip").on("click", function () {
            $(".t50-timeline").removeClass("sticky");
        })

        // DRAG TO SCROLL FOR DESKTOP
        const slider = document.querySelector('.t50-timeline .slides');
        let isDown = false;
        let startX;
        let scrollLeft;

        slider.addEventListener('mousedown', (e) => {
            isDown = true;
            slider.classList.add('active');
            document.querySelector('.t50-timeline').classList.add("scrolled");
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        });
        slider.addEventListener('mouseleave', () => {
            isDown = false;
            slider.classList.remove('active');
        });
        slider.addEventListener('mouseup', () => {
            isDown = false;
            slider.classList.remove('active');
            checkVisibleSlide();
            highlightYearAndCat();
            handleTreeGrowth();
        });
        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 3; //scroll-fast
            slider.scrollLeft = scrollLeft - walk;
        });

        const sliderNav = document.querySelector('.t50-timeline .slider-nav');
        sliderNav.addEventListener('mousedown', (e) => {
            isDown = true;
            startX = e.pageX - sliderNav.offsetLeft;
            scrollLeft = sliderNav.scrollLeft;
        });
        sliderNav.addEventListener('mouseleave', () => {
            isDown = false;
        });
        sliderNav.addEventListener('mouseup', () => {
            isDown = false;
        });
        sliderNav.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - sliderNav.offsetLeft;
            const walk = (x - startX) * 3; //scroll-fast
            sliderNav.scrollLeft = scrollLeft - walk;
        });
        // DRAG TO SCROLL FOR DESKTOP END



        $(".seek a").on("click", function (e) {
            var target = $(this).attr("href");
            var offset = -350;

            if (windowWidth < 840) {
                offset = -20;
            }
            $(".t50-timeline").addClass("scrolled");

            $(".seek li").removeClass("active")
            $(this).parent().addClass("active");

            $(".t50-timeline .slides").scrollTo(target, 1000, { offset: offset });

            setTimeout(function () {
                checkVisibleSlide();
                highlightYearAndCat();
                handleTreeGrowth();
            }, 1000);
        });

        $(".slider-nav a").on("click", function (e) {
            var target = $(this).attr("href");
            var targetO = $(this).outerWidth();
            var slickIndex = $(this).data("slick-index");
            var offset = -350;

            if (windowWidth < 840) {
                offset = -20;
            }
            $(".t50-timeline").addClass("scrolled");
            $(".slider-nav a").removeClass("slick-current");
            $(this).addClass("slick-current");
            timelineTracking($(this).attr("class").substring(0, 5));

            $(".t50-timeline .slides").scrollTo(target, 300, { offset: offset });
            $(".slider-nav").scrollTo($(this), 0, { offset: 0 });

            setTimeout(function () {
                checkVisibleSlide();
                handleTreeGrowth();
            }, 1000);

            e.preventDefault();
        });

        $(".t50-timeline .go-to-year").on("click", function (e) {
            var year = $(this).data("year");

            e.preventDefault();

            $(".slider-nav a." + year).trigger("click");
        });

        if (windowWidth < 840) {
            $(".t50-timeline .seek-container >*:not(.seek)").on("click", function (e) {
                e.preventDefault();
                $(".t50-timeline .seek-container").toggleClass("show-seek");
            });
        }

    }

    function checkVisibleSlide() {
        $(".t50-timeline .slide").each(function () {
            if ($(this).isInViewport()) {
                $(this).addClass("visible");
            } else {
                $(this).removeClass("visible");
            }
        });
        $(".t50-timeline .bg-container").each(function () {
            if ($(this).isInViewport()) {
                $(this).addClass("visible");
            } else {
                $(this).removeClass("visible");
            }
        });
    }

    function resizeVideoSection() {
        if (windowWidth < 840) {
            var containerHeight = $(".video-popup-container > .expand").outerHeight();

            $(".video-popup-container").css("paddingTop", containerHeight);
        } else {
            $(".video-popup-container").css("paddingTop", "");

        }
    }
    $.fn.isInViewport = function () {
        var elementLeft = $(this).offset().left;
        var elementWidth = elementLeft + $(this).outerWidth();

        var viewportLeft = $(window).scrollLeft();
        var viewportBottom = viewportLeft + $(window).width();

        return elementWidth > viewportLeft && elementLeft < viewportBottom;
    };

    function highlightYearAndCat() {
        // HIGHLIGHT CATEGORY
        var activeCat = $(".t50-timeline .bg-container.visible").last().data("seek");
        var targetCat = $(".seek a." + activeCat);

        $(".seek li").removeClass("active");
        targetCat.parent().addClass("active");

        // HIGHLIGHT YEAR
        var activeSlide = $(".t50-timeline .slide.visible").last().data("year");
        var target = $(".slider-nav a." + activeSlide);
        var targetPos = target.offset().left;
        var offset = target.outerWidth();
        targetPos = targetPos + (targetPos / 2);

        $(".slider-nav a").removeClass("slick-current");
        target.addClass("slick-current");
        timelineTracking(activeSlide);
    }

    function handleTreeGrowth() {
        var activeTreeSlide = $(".t50-timeline .slide.visible").last().data("tree");

        $(".logo img").removeClass("show");
        $(".logo img." + activeTreeSlide).addClass("show");
    }

    t50Timeline();
    repositionPlayBtn();
    checkDevice();
    resizeVideoSection();
});
