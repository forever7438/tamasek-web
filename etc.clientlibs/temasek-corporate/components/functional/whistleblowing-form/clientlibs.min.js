/*jslint browser: true, fudge: true, long: true */
/*global $, _satellite, alert, blacksunplc, clearTimeout, console, jQuery, setTimeout */

(function () {
    "use strict";

    var emails = blacksunplc.emails; // import * as emails from "module:blacksunplc/emails"

    function clearValidationErrors($element) {
        $element.closest(".required").removeClass("error-in-value");
        $element.closest(".required").find(".error-message").hide();
    }

    function validateMessage() {
        var $message = $("#fld-message");
        clearValidationErrors($message);
        console.debug("Validating", $message);
        var textVal = $message.val();
        if (!textVal) {
            $message.closest(".required").addClass("error-in-value");
            $("#fld-message_error-missing").show();
        }
    }

    function validateCountryCode() {
    	var numbers = /^\+?\d+$/;
        var $countryCode = $("#fld-country");
        clearValidationErrors($countryCode);
        console.debug("Validating", $countryCode);
        var countryCodeVal = /** @type {string} */ ($countryCode.val());
        if (countryCodeVal && !countryCodeVal.match(numbers)) {
        	$countryCode.closest(".required").addClass("error-in-value");
            $("#fld-country_error-missing").show();
        }
    }

    function validatePhoneNumber() {
    	var numbers = /^[0-9-]+$/;
        var $phone = $("#fld-phone");
        clearValidationErrors($phone);
        console.debug("Validating", $phone);
        var phoneVal = /** @type {string} */ ($phone.val());
        if (phoneVal && !phoneVal.match(numbers)) {
        	$phone.closest(".required").addClass("error-in-value");
            $("#fld-phone_error-missing").show();
        }
    }
    
    function validateEmail() {
        var $email = $("#fld-email");
        clearValidationErrors($email);
        console.debug("Validating", $email);
        var emailVal = /** @type {string} */ ($email.val());
        if (!emailVal) {
            $email.closest(".required").addClass("error-in-value");
            $("#fld-email_error-missing").show();
        } else if (!emails.isValidAddrSpec(emailVal)) {
            $email.closest(".required").addClass("error-in-value");
            $("#fld-email_error-invalid").show();
        }
    }

    function validateEmails() {
        validateEmail();
    }

    function validatePdpaDisclaimer() {
        var $pdpaDisclaimer = $("#fld-pdpa-disclaimer");
        clearValidationErrors($pdpaDisclaimer);
        console.debug("Validating", $pdpaDisclaimer);
        if (!$pdpaDisclaimer.is(":checked")) {
            $pdpaDisclaimer.closest(".required").addClass("error-in-value");
            $("#fld-pdpa-disclaimer_error-missing").show();
        }
    }

    function validateGoogleReCaptcha() {
        var $googleReCaptchaResponse = $("#g-recaptcha-response");
        clearValidationErrors($googleReCaptchaResponse);
        console.debug("Validating", $googleReCaptchaResponse);
        var responseVal = $googleReCaptchaResponse.val();
        if (!responseVal) {
            $googleReCaptchaResponse.closest(".required").addClass("error-in-value");
            $("#g-recaptcha_error-missing").show();
        }
    }

    function validateForm() {
        validateMessage();
        validateCountryCode();
        validatePhoneNumber();
        validateEmails();
        validatePdpaDisclaimer();
        validateGoogleReCaptcha();
    }

    function formValid() {
        return $("#whistleblowing-form").find(".error-in-value").length === 0;
    }

    function delayedValidation($element, event, validationFn, delayMillis) {
        var timeoutID = -1;
        $element.on(event, function () {
            if (timeoutID !== -1) {
                console.debug("Clearing timeout.", $element, event, delayMillis, timeoutID);
                clearTimeout(timeoutID);
            }
            timeoutID = setTimeout(validationFn, delayMillis);
        });
    }

    function initValidation() {
        console.debug("Initialising validation.");

        $("#fld-message").on("keyup", validateMessage);
        // $("#fld-name").on("keyup", validateName);
        delayedValidation($("#fld-email"), "keyup", validateEmails, 250);

        $("#fld-message").on("blur", validateMessage);
        // $("#fld-name").on("blur", validateName);
        $("#fld-email").on("blur", validateEmails);
        $("#fld-pdpa-disclaimer").on("click", validatePdpaDisclaimer);
    }

    function scrollToFirstFieldWithError() {
        var position = $(".error-in-value").offset().top - $("header").height();
        $("html, body").animate({
            scrollTop: position
        }, 500);
    }

    jQuery(function ($) { 
        initValidation();
        $("#whistleblowing-form").on("submit", function (/** !jQuery.Event */ event) {
            event.preventDefault();

            validateForm();

            if (!formValid()) {
                console.debug("Invalid form.");
                scrollToFirstFieldWithError();
                return;
            }

            $("#whistleblowing-form").find("input[type='submit']").prop("disabled", true);

            jQuery.ajax("/bin/public/temasek-corporate/whistleblowing-form", {
                method: "POST",
                data: $("#whistleblowing-form").serialize()
            }).done(function () {
                $("#whistleblowing-form, .form-intro").slideUp(function () {
                    $("#whistleblowing-form-success-message").show();
                });
                
                setTimeout(() => {
                    var position = $("#whistleblowing-form-success-message").offset().top - $("header").height() - 50;

                    $("html, body").animate({
                        scrollTop: position
                    }, 500);
                }, 500);
                

                _satellite.track("contactFormSubmitSuccess");

            }).fail(function () {
                alert($("#whistleblowing-form-error-message").text());
                $("#whistleblowing-form").find("input[type='submit']").prop("disabled", false);
            });
        });
    });

}());
