
jQuery(function ($) {
	"use strict";
	var arrays = blacksunplc.arrays; // import * as arrays from "module:blacksunplc/arrays"
	var width = $(window).width();
	var tags = $(".t50-grid-container.tiles").data("tags");
	var view = $(".t50-grid-container.tiles").data("view");
	var lang = $(document.body).data("languageName");

	if ($(window).width() < 768) {
		view = 10;
	}

	$(".t50-grid-container:not(.fixed-list) .t50-grid-item > *:not(.pop-up)").on("click", function () {
		var id = $(this).parent().attr("id");

		$(this).parent().find(".pop-up").fadeIn("fast");
		updateUrl(id);
		readTime(id);
	});

	$("body").on("click", ".t50-grid-container.fixed-list .t50-grid-item.expand .popup", function () {
		var id = $(this).parent().parent().attr("id");

		$(this).parent().parent().find(".pop-up").fadeIn("fast");
		updateUrl(id);
		readTime(id);
	});

	$(".close-popup").on("click", function (e) {
		e.preventDefault();
		$(this).parent().parent().fadeOut("fast");
		$('iframe').attr('src', $('iframe').attr('src'));
		$('.page > .par video').trigger('pause');

		var currentUrl = location.href;
		var url = new URL(currentUrl);

		url.searchParams.delete("showPopup"); // setting your param
		var newUrl = url.href;
		history.pushState(null, "", newUrl);
	});

	$(".close-slide").on("click", function (e) {
		e.preventDefault();
		$(".fixed-list .t50-grid-item").removeClass("expand");
		$(".fixed-list .t50-grid-item .popup").removeClass("popup");
	});

	$("body").on("click", ".t50-grid-item:not(.expand) .show-popup.expand", function () {
		$(".fixed-list .t50-grid-item").removeClass("expand");
		$(".fixed-list").addClass("expand");
		$(this).parent().parent().addClass("expand");
		$(this).addClass("popup");

		$(".t50-grid-item.expand .details .title").css("height", "");
		setTimeout(function () {
			handleTitleHeight();
		}, 500);
	});

	$("body").on("click", ".t50-grid-item.expand", function () {
		$(this).removeClass("expand");
		$(".fixed-list").addClass("expand");
		setTimeout(function () {
			handleTitleHeight();
		}, 700);
	});

	if (tags) {
		var className;
		var arr = [];
		tags = tags.replace("[", "");
		tags = tags.replace("]", "");

		tags = tags.split(",");

		tags.forEach(function (val) {
			val = val.trim();
			if (val && arr.indexOf(val) == -1) {
				arr.push(val);
			}
		});

		arr.forEach(function (val) {
			className = val.toLowerCase();
			className = className.replace(" ", "-")
			$(".t50-filter ul").append("<li data-class=" + className + ">" + val + "</li>")
		});
		showStories();
	}

	if ($(".t50-grid-item").length > 0) {

		$(".t50-grid-item").each(function () {
			var tag;
			var tagList = "";
			var classList = "";
			tag = $(this).find(">.tag").text();
			tag = tag.split(",");

			if (tag != "") {
				tag.forEach(function (val) {
					if (val) {
						tagList = tagList + " <span>" + val + "</span>";

						val = val.toLowerCase();
						val = val.replace(" ", "-");
						classList = classList + " " + val;
					}
				});

				$(this).addClass(classList);
				$(this).find(".pop-up .tag").empty();
				$(this).find(".pop-up .tag").append(tagList);
			}
		});
	}

	$(".t50-filter p").on("click", function () {
		$(".t50-filter ul").slideToggle();
		$(".t50-filter").toggleClass("expand");
	});

	$(".t50-filter li").on("click", function () {
		var selected = $(this).data("class");
		$(".t50-filter p span").text($(this).text());

		$(".t50-filter ul").slideToggle();
		$(".t50-filter").toggleClass("expand");

		$(".tiles .t50-grid-item").show();

		if (selected !== 'all') {
			$(".tiles .t50-grid-item:not(." + selected + ")").hide();
			$(".t50-load-more-stories").hide();
		} else {
			$(".tiles .t50-grid-item:not(.loaded)").css("display", "");
			$(".t50-load-more-stories").show();
		}
	});

	$(".t50-load-more-stories").on("click", function (e) {
		e.preventDefault();

		showStories();
		handleTitleHeight();
	});

	$(".homepage-stories-container .t50-grid-item").on("click", function () {
		var t50Page = $(".homepage-stories-container").data("t50-page");
		var popupId = $(this).data("popup");

		window.location.href = window.location.origin + t50Page + "?showPopup=" + popupId;
	});

	$(window).on('resize', function () {
		$(".t50-stories .fixed-list .t50-grid-item .details .title").css("height", "");

		if ($(this).width() !== width) {
			width = $(this).width();
			calculateStoryHeight();
		}

		if ($(window).width() < 768) {
			view = 10;

		} else {
			view = 15;
		}

		showStories();
		handleViewStoriesButton();
		calculateStoryHeight();
		setTimeout(function() {
			handleTitleHeight();
			
		}, 1000);
	});

	function showStories() {
		if ($("body").hasClass("author-mode")) {
			$(".tiles .t50-grid-item").each(function (ind, val) {
				if (ind + 1 <= view) {
					$(this).addClass("loaded");
				}
			});
		} else {
			$(".tiles .t50-grid-item").removeClass("loaded");

			$(".tiles .t50-grid-item").each(function (ind, val) {
				if (ind + 1 <= view) {
					$(this).addClass("loaded");
				}
			});

			if ($(".tiles .t50-grid-item").length > view) {
				view = view * 2;
			} else {
				$(".t50-load-more-stories").hide();
			}
		}


	}

	function handleViewStoriesButton() {
		width = $(window).width();
		var btn = $(".homepage-stories-container .view-all-stories");

		if (width > 960) {
			$(".homepage-stories-container .t50-top-content > .flex").append(btn);
		} else {
			$(".homepage-stories-container > .flex").append(btn);
		}
	}

	function calculateStoryHeight() {
		var height = $(".tiles .t50-grid-item:first-child").outerWidth();

		if ($(".homepage-stories-container").length > 0) {
			height = $(".homepage-stories-container .t50-grid-item:first-child").outerWidth();
		}

		$(".t50-grid-item").css("height", height + "px");
	}

	function handleTitleHeight() {
		var titleHeight = 0;
		var tileTitleHeight = 0;
		if (width > 960) {
			$(".t50-stories .fixed-list .t50-grid-item:not(.expand) > .details > .title").each(function () {
				$(this).css("height", "");
				if ($(this).outerHeight() > titleHeight) {

					titleHeight = $(this).outerHeight();
					$(this).css("height", "100px");
				}
			});

			$(".t50-stories .fixed-list .t50-grid-item:not(.expand) > .details > .title").css("height", titleHeight + "px");

			$(".t50-stories .tiles .t50-grid-item:not(.expand) > .details > .title").each(function () {
				$(this).css("height", "");
				if ($(this).outerHeight() > tileTitleHeight) {

					tileTitleHeight = $(this).outerHeight();
					$(this).css("height", "100px");
				}
			});

			$(".t50-stories .tiles .t50-grid-item:not(.expand) > .details > .title").css("height", tileTitleHeight + "px");
		} else {
			$(".t50-stories .tiles .t50-grid-item > .details > .title").css("height", "");

			$(".t50-stories .homepage-stories-container .t50-grid-item > .details > .title").css("height", "");

			$(".t50-stories .fixed-list .t50-grid-item:not(.expand) > .details > .title").css("height", "");

			$(".t50-stories .tiles .t50-grid-item:not(.expand) > .details > .title").css("height", "");
		}
	}

	function updateUrl(id) {
		var currentUrl = location.href;
		var url = new URL(currentUrl);
		var idPar = id;

		url.searchParams.set("showPopup", idPar); // setting your param
		var newUrl = url.href;
		history.pushState(null, "", newUrl);
	}

	function readTime(id) {
		var counter = 0;
		var readTime = 1;
		var pageText = $("#" + id + " .pop-up .par.parsys").text();

		if ("zh" === lang) {
			readTime = pageText.length / 500;
			readTime = Math.round(readTime);
		} else {
			pageText = pageText.split(" ");
			arrays.forEach(pageText, function (word) {
				if (word.trim().length > 0) {
					counter = counter + 1;
				}
			});

			readTime = counter / 225;
			readTime = Math.round(readTime);
		}

		if(readTime == 0) {
			readTime = 1; //minimum 1min read
		}

		console.log($("#" + id + " .read-time span"));
		$("#" + id + " .read-time span").text(readTime);
	}

	calculateStoryHeight();
	handleViewStoriesButton();
	handleTitleHeight();
});

$(window).on("load", function () {

	if (getUrlParameter('showPopup')) {
		var popupId = $("#" + getUrlParameter('showPopup'));
		var articlePage = parseInt(popupId.index() / 15);

		for (let index = 1; index <= articlePage; index++) {
			$(".t50-load-more-stories").trigger("click");
			$('html, body').animate({
				scrollTop: popupId.offset().top - 80
			}, 100);
		}

		setTimeout(function () {
			$('html, body').animate({
				scrollTop: popupId.offset().top - 80
			}, 100);
		}, 100);

		setTimeout(function () {
			popupId.find(".show-popup").trigger("click");
		}, 1000);
		setTimeout(function () {
			if(popupId.find(".show-popup").hasClass("expand")) {
				popupId.find(".show-popup.expand").trigger("click");
			}
		}, 1500);
	}

	
	function getUrlParameter(sParam) {
		var sPageURL = window.location.search.substring(1),
			sURLVariables = sPageURL.split('&'),
			sParameterName,
			i;

		for (i = 0; i < sURLVariables.length; i++) {
			sParameterName = sURLVariables[i].split('=');

			if (sParameterName[0] === sParam) {
				return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
			}
		}
		return false;
	};
});
